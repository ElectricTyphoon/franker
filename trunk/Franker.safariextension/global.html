<html>
	<head>
		<title>The Real Franker!</title>
		<script type="text/javascript" src="http://www.google.com/jsapi">
	    </script>
		<script type="text/javascript">
			function performCommand(event) {
				if (event.command === "frankate_selection") {
					safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("frankateSelection", "");
				}
			}
			safari.application.addEventListener("command", performCommand, false);
		</script>
		<script type="text/javascript">
			google.load("language", "1");
			var srcText;
			var langDst = safari.extension.settings.lang_dst;
			function translateCallBack(result) {
				safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("frankateSelectionResponse", result.translation);
			}
			function respondToMessage(theMessageEvent) {
				var activeTab = safari.application.activeBrowserWindow.activeTab;
		    	if(theMessageEvent.name === "frankateSelectionRequest") {
					srcText = theMessageEvent.message;
					langDst = safari.extension.settings.lang_dst;
					if (safari.extension.settings.lang_src == "auto") {
						google.language.translate(srcText, "", langDst, translateCallBack);
					} else {
						google.language.translate(srcText, safari.extension.settings.lang_src, langDst, translateCallBack);
					}
				} else if (theMessageEvent.name === "shortcutFrankateSelectionRequest") {
					activeTab.page.dispatchMessage("shortcutFrankateSelectionValue", safari.extension.settings.shortcut_frankate_selection);
				} else if (theMessageEvent.name === "shortcutFrankateCleanRequest") {
					activeTab.page.dispatchMessage("shortcutFrankateCleanValue", safari.extension.settings.shortcut_frankate_clean);
				} else if (theMessageEvent.name === "styleDestinationRequest") {
					activeTab.page.dispatchMessage("styleDestinationValue", safari.extension.settings.style_dst);
				}
			}
			safari.application.addEventListener("message", respondToMessage, false);
		</script>
		<!-- Settings change watcher -->
		<script>
			function settingsChanged(event) {
				var activeTab = safari.application.activeBrowserWindow.activeTab;
				if (event.key == "shortcut_frankate_selection") {
					activeTab.page.dispatchMessage("shortcutFrankateSelectionValue", event.newValue + ":" + event.oldValue);
				} else if (event.key == "shortcut_frankate_clean") {
					activeTab.page.dispatchMessage("shortcutFrankateCleanValue", event.newValue + ":" + event.oldValue);
				}
			}
			safari.extension.settings.addEventListener("change", settingsChanged, false);
		</script>
	</head>
	<body>
	</body>
</html>
