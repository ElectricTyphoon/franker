<html>
	<head>
		<title>The Real Franker!</title>
		<script type="text/javascript" src="http://www.google.com/jsapi?key=INSERT-YOUR-KEY">
		</script>
		<script type="text/javascript">
			google.load("language", "1");
			var bingAppID = "INSERT-YOUR-KEY";
		</script>
		<script type="text/javascript">
			// broadcasts a message to all pages, used to propagate the settings (see issue #7)
			function broadcastMessage(name, payload) {
				for (var w = 0; w < safari.application.browserWindows.length; w++) {
					for (var t = 0; t < safari.application.browserWindows[w].tabs.length; t++) {
						safari.application.browserWindows[w].tabs[t].page.dispatchMessage(name, payload);
					}
				}
			}
			// sends a message to active page
			function sendMessage(name, payload) {
				safari.application.activeBrowserWindow.activeTab.page.dispatchMessage(name, payload);
			}
		</script>
		<script type="text/javascript">
			function translate(text) {
				var langSrc = safari.extension.settings.lang_src;
				if (langSrc == "auto") {
					langSrc = "";
				}
				var langDst = safari.extension.settings.lang_dst;
				var engine = safari.extension.settings.engine;
				
				if (engine == "GOOGLE") {
					google.language.translate(text, langSrc, langDst, translateCallBack);
				} else if (engine == "BING") {
					var bingURL = "http://api.microsofttranslator.com/V2/Ajax.svc/Translate?oncomplete=translateCallBack&appId="+bingAppID+"&from=" + langSrc + "&to=" + langDst + "&contentType=text/html&text=" + encodeURIComponent(text);
					injectScript("frankerBingScript", bingURL);
				}
			}
			function translateCallBack(result) {
				var translation = "";
				var engine = safari.extension.settings.engine;
				if (engine == "GOOGLE") {
					translation = result.translation;
				} else if (engine == "BING") {
					translation = result;
				}
				sendMessage("frankateSelectionResponse", translation);
			}
			function respondToMessage(theMessageEvent) {
				switch (theMessageEvent.name) {
					case "frankateSelectionRequest":
						translate(theMessageEvent.message);
						break;
					
					// settings
					case "shortcutFrankateSelectionRequest":
						broadcastMessage("shortcutFrankateSelectionValue", safari.extension.settings.shortcut_frankate_selection);
						break;
					case "shortcutFrankateClearRequest":
						broadcastMessage("shortcutFrankateClearValue", safari.extension.settings.shortcut_frankate_clear);
						break;
					case "styleDestinationRequest":
						broadcastMessage("styleDestinationValue", safari.extension.settings.style_dst);
						break;
					case "injectBeforeRequest":
						broadcastMessage("injectBeforeValue", safari.extension.settings.inject_before);
						break;
					case "injectBracketsRequest":
						broadcastMessage("injectBracketsValue", safari.extension.settings.inject_brackets);
						break;

					// extra
					case "frankatePageRequest":
						var langSrc=safari.extension.settings.lang_src;
						if (langSrc == "auto") {
							langSrc = "" // means "detect language"
						}
						var langDst=safari.extension.settings.lang_dst;
						var activeTab = safari.application.activeBrowserWindow.activeTab;
						activeTab.url = 'http://translate.google.com/translate?u='+escape(activeTab.url)+'&hl='+langDst+'&ie=UTF-8&sl='+langSrc+'&tl='+langDst
						break;
					case "shortcutFrankatePageRequest":
						broadcastMessage("shortcutFrankatePageValue", safari.extension.settings.shortcut_frankate_page);
						break;
					case "statePageEnabledRequest":
						sendMessage("statePageEnabledValue", safari.extension.settings.state_frankate_page);
						break;
				}
			}
			function injectScript(id, url){
				var s = document.getElementById(id);
				if (s != null) {
					document.getElementsByTagName("head")[0].removeChild(s);
				}
				s = document.createElement("script");
				s.id = id;
				s.type = "text/javascript";
				s.src = url;
				document.getElementsByTagName("head")[0].appendChild(s);
			}
			safari.application.addEventListener("message", respondToMessage, false);
		</script>
		<!-- Context menu and toolbar buttons watcher -->
		<script type="text/javascript">
			function performCommand(event) {
				if (event.command === "frankate_selection") {
					sendMessage("frankateSelection", "");
				}
				if (event.command === "frankate_page") {
					sendMessage("frankatePage", "");
				}
			}
			safari.application.addEventListener("command", performCommand, false);
		</script>
		<!-- Settings change watcher -->
		<script>
			function settingsChanged(event) {
				switch (event.key) {
					case "shortcut_frankate_selection":
						broadcastMessage("shortcutFrankateSelectionValue", event.newValue + ":" + event.oldValue);
						break;
					case "shortcut_frankate_clear":
						broadcastMessage("shortcutFrankateClearValue", event.newValue + ":" + event.oldValue);
						break;
					case "shortcut_frankate_page":
						broadcastMessage("shortcutFrankatePageValue", event.newValue + ":" + event.oldValue);
						break;
				}
			}
			safari.extension.settings.addEventListener("change", settingsChanged, false);
		</script>
	</head>
	<body>
	</body>
</html>
