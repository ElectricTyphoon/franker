<html>
	<head>
		<title>The Real Franker!</title>
		<script type="text/javascript" src="http://www.google.com/jsapi">
	    </script>
		<script type="text/javascript">
			function performCommand(event) {
				if (event.command === "frankate_selection") {
					safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("frankateSelection", "");
				}
				if (event.command === "frankate_page") {
					safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("frankatePage", "");
				}
			}
			safari.application.addEventListener("command", performCommand, false);
		</script>
		<script type="text/javascript">
			google.load("language", "1");
			var srcText;
			var langDst = safari.extension.settings.lang_dst;
			function translateCallBack(result) {
				safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("frankateSelectionResponse", result.translation);
			}
			function respondToMessage(theMessageEvent) {
				var activeTab = safari.application.activeBrowserWindow.activeTab;
				switch (theMessageEvent.name) {
					case "frankateSelectionRequest":
						srcText = theMessageEvent.message;
						langDst = safari.extension.settings.lang_dst;
						if (safari.extension.settings.lang_src == "auto") {
							google.language.translate(srcText, "", langDst, translateCallBack);
						} else {
							google.language.translate(srcText, safari.extension.settings.lang_src, langDst, translateCallBack);
						}
						break;
					
					// settings
					case "shortcutFrankateSelectionRequest":
						activeTab.page.dispatchMessage("shortcutFrankateSelectionValue", safari.extension.settings.shortcut_frankate_selection);
						break;
					case "shortcutFrankateClearRequest":
						activeTab.page.dispatchMessage("shortcutFrankateClearValue", safari.extension.settings.shortcut_frankate_clear);
						break;
					case "styleDestinationRequest":
						activeTab.page.dispatchMessage("styleDestinationValue", safari.extension.settings.style_dst);
						break;

					// extra
					case "frankatePageRequest":
						var langSrc=safari.extension.settings.lang_src;
						if (langSrc == "auto") {
							langSrc = "" // means "detect language"
						}
						var langDst=safari.extension.settings.lang_dst;
						activeTab.url = 'http://translate.google.com/translate?u='+escape(safari.application.activeBrowserWindow.activeTab.url)+'&hl='+langDst+'&ie=UTF-8&sl='+langSrc+'&tl='+langDst
						break;
					case "shortcutFrankatePageRequest":
						activeTab.page.dispatchMessage("shortcutFrankatePageValue", safari.extension.settings.shortcut_frankate_page);
						break;
					case "statePageEnabledRequest":
						activeTab.page.dispatchMessage("statePageEnabledValue", safari.extension.settings.state_frankate_page);
						break;
				}
			}
			safari.application.addEventListener("message", respondToMessage, false);
		</script>
		<!-- Settings change watcher -->
		<script>
			function settingsChanged(event) {
				var activeTab = safari.application.activeBrowserWindow.activeTab;
				switch (event.key) {
					case "shortcut_frankate_selection":
						activeTab.page.dispatchMessage("shortcutFrankateSelectionValue", event.newValue + ":" + event.oldValue);
						break;
					case "shortcut_frankate_clear":
						activeTab.page.dispatchMessage("shortcutFrankateClearValue", event.newValue + ":" + event.oldValue);
						break;
					case "shortcut_frankate_page":
						activeTab.page.dispatchMessage("shortcutFrankatePageValue", event.newValue + ":" + event.oldValue);
						break;
				}
			}
			safari.extension.settings.addEventListener("change", settingsChanged, false);
		</script>
	</head>
	<body>
	</body>
</html>
